import { type BetterAuthPlugin, betterAuth } from "better-auth"
import { drizzleAdapter } from "better-auth/adapters/drizzle"

import type { db } from "@init/db"
import type { db as dbServerless } from "@init/db/serverless"
import { APP_ID, APP_NAME } from "@init/utils/constants"

export const SESSION_EXPIRES_IN = 60 * 60 * 24 * 30 // 30 days
export const SESSION_UPDATE_AGE = 60 * 60 * 24 * 15 // 15 days

type CreateAuthOptions = Omit<
  Parameters<typeof betterAuth>[0],
  "appName" | "secret" | "database" | "advanced" | "session" | "plugins"
> & { secret: string; database: typeof db | typeof dbServerless }

export function createAuth<const Plugins extends BetterAuthPlugin[]>(
  options: CreateAuthOptions,
  plugins: Plugins = [] as unknown as Plugins
) {
  const { database, ...rest } = options

  return betterAuth({
    appName: APP_NAME,
    database: drizzleAdapter(database, {
      provider: "pg",
      usePlural: true,
    }),
    advanced: {
      database: {
        // We rely on ids generated by the database
        generateId: false,
      },
      cookiePrefix: APP_ID,
    },
    session: {
      expiresIn: SESSION_EXPIRES_IN,
      updateAge: SESSION_UPDATE_AGE,
    },
    plugins,
    ...rest,
  })
}

export type Auth = ReturnType<typeof createAuth>

export { APIError as AuthError } from "better-auth/api"
